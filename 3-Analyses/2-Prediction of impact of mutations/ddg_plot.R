#!/usr/bin/env Rscript
# Title: dgg_plot.R
# Version: 0.0
# Author: Frédéric CHEVALIER <fcheval@txbiomed.org>
# Created in: 2019-05-02
# Modified in:



#==========#
# Comments #
#==========#

# Create a barplot the ddG values generated by ddg_monomer protocol from Rosetta.
# These values were summarized in a table first.



#==========#
# Versions #
#==========#

# v0.0 - 2019-05-02: creation



#===========#
# Variables #
#===========#

ddg_file <- "ddg_analysis/ddg_mutations.tsv"
mut_file <- "Non-syn_mutation_annotation.tsv"

graph_dir <- "graphs"
fig_file  <- "Fig. 4 - ddG analysis.pdf"



#=================#
# Data processing #
#=================#

# Load data
mydata <- read.csv(ddg_file, header=FALSE, sep="\t")
mut.ls <- read.csv(mut_file, header=FALSE, sep="\t")

# Remove duplicated mutations
mut.ls <- mut.ls[ ! duplicated(mut.ls), ]

# Update data (name of mutation and ordering)
mydata[,1] <- gsub("^", "p.", mydata[,1])
mydata     <- merge(mydata, mut.ls, by=1)
mydata     <- mydata[ order(mydata[,2], decreasing=TRUE), ]

# Color code for the type of mutation
## note: Putative and Validated were not used in the final version.
## Putative refered to putative resistant alleles.
## Validated refered to validated resistant alleles using the activation assay.
mydata[,ncol(mydata)+1] <- NA
mydata[ mydata[,3] == "Neutral"     & mydata[,4] == "Validated", ncol(mydata)] <- "grey"  # "black"
mydata[ mydata[,3] == "Neutral"     & mydata[,4] == "Putative",  ncol(mydata)] <- "white"
mydata[ mydata[,3] == "Deleterious" & mydata[,4] == "Putative",  ncol(mydata)] <- "white" # "orange"
mydata[ mydata[,3] == "Deleterious" & mydata[,4] == "Validated", ncol(mydata)] <- "red"

# Shade density for highlighting known mutation not in the data set
mydata[,ncol(mydata)+1] <- "black"
mydata[ mydata[,1] == "p.C35R", ncol(mydata) ]  <- "grey"
mydata[ mydata[,1] == "p.G206V", ncol(mydata) ] <- "grey"



#=========#
# Figures #
#=========#

# Create the graph folder if not present
if (! dir.exists(graph_dir)) {dir.create(graph_dir)}

# cairo_pdf is needed for UTF-16 (to some greek letters)
## source: https://stackoverflow.com/a/5886296
cairo_pdf(paste(graph_dir,fig_file,sep="/"), width=5, height=10)
    par(mar=c(5,5,1,1)+0.1)

    myx <- c(round(min(mydata[,2])), seq(0, round(max(mydata[,2])), length=5))

    mybp <- barplot(mydata[,2], col=mydata[,ncol(mydata)-1], xlim=c(myx[1],myx[length(myx)]), xlab=expression(italic(Delta * Delta * "G") * " (kcal.mol"^-1 * ")"), las=2, horiz=TRUE, axes=FALSE)
    axis(1, at=myx)
    for (i in unique(mydata[,ncol(mydata)])) { axis(2, at=mybp[ mydata[,ncol(mydata)] == i,], labels=mydata[ mydata[,ncol(mydata)] == i, 1], col.axis=i, las=2, tick=FALSE) }

dev.off()
